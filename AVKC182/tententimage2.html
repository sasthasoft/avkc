<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shop Rental Management</title>
<style>
body{ font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }

/* HEADER */
header{ background:#c2185b; color:#fff; padding:15px; text-align:center; font-size:22px; }

/* SEARCH BAR */
.search-box{ display:flex; justify-content:center; align-items:center; flex-wrap:wrap; gap:8px; padding:15px; background:#fce4ec; }
.search-box input{ padding:10px; border:1px solid #c2185b; border-radius:6px; width:250px; }
.search-box button{ padding:10px 20px; background:#c2185b; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }

/* LOADING MESSAGE */
#loadingMessage{ text-align:center; font-size:18px; color:#c2185b; margin:20px 0; font-weight:bold; }

/* CARD VIEW */
.list{ display:flex; flex-wrap:wrap; gap:15px; padding:15px; justify-content:center; }
.card{ width:320px; background:#fff; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,.1); overflow:hidden; border-top: 4px solid #c2185b; }
.card-header{ display:flex; align-items:center; padding:12px; background:#fff3f8; }
.card img.profile-thumb{ width:70px; height:80px; object-fit:cover; border-radius:6px; border:1px solid #ddd; margin-right:12px; background:#eee; }
.card-body{ padding:12px; }
.card-body h3{ margin:0; font-size:18px; color:#c2185b; }
.card-body p{ margin:6px 0; font-size:14px; color:#444; }
.card-body .btn-print{ width:100%; background:#c2185b; color:#fff; border:none; padding:10px; border-radius:6px; margin-top:10px; cursor:pointer; font-weight:bold; }

/* PRINT PREVIEW */
#previewBox{ display:none; position:fixed; inset:0; background:#fff; overflow:auto; padding:10px; z-index:9999; }
.noPrint{ background:#c2185b; color:#fff; border:none; padding:10px 15px; border-radius:6px; margin:5px; cursor:pointer; font-weight:bold; }

/* PRINT PAGE */
.print-page{ width:210mm; min-height:297mm; margin:auto; padding:10mm; box-sizing:border-box; background:#fff; }
.print-header{ display:flex; align-items:center; justify-content:space-between; border-bottom:2px solid #c2185b; padding-bottom:10px; margin-bottom:15px; }
.print-header img{ width:70px; }
.print-header-title{ flex:1; text-align:center; font-size:24px; font-weight:bold; color:#c2185b; }

/* MULTIPLE IMAGES SECTION */
.print-tenants{ display:flex; flex-wrap:wrap; gap:12px; margin-bottom:20px; justify-content:center; }
.print-tenants .img-wrap{ display:flex; flex-direction:column; align-items:center; border:1px solid #ddd; padding:5px; border-radius:8px; width:120px; }
.print-tenants img{ width:110px; height:130px; object-fit:cover; border-radius:4px; margin-bottom:5px; background:#eee; }
.print-tenants span{ color:#880e4f; font-weight:bold; font-size:12px; text-align:center; }

/* DETAILS TABLE */
.print-table{ width:100%; border-collapse:collapse; font-size:15px; }
.print-table th{ background:#fce4ec; border:1px solid #c2185b; padding:10px; text-align:left; width:35%; color:#880e4f; }
.print-table td{ border:1px solid #c2185b; padding:10px; color:#333; }

/* PRINT MEDIA */
@media print{
  body *{visibility:hidden}
  #previewBox, #previewBox *{visibility:visible}
  #previewBox{ position:absolute; left:0; top:0; width:100%; padding:0; }
  .noPrint{display:none}
}
</style>
</head>
<body>

<header>Shop Rental Management</header>

<div class="search-box">
  <input id="searchShop" placeholder="Shop No / Tenant Name / Mobile">
  <button onclick="load()">üîç Search</button>
</div>

<h2 id="loadingMessage">Loading Data... Please wait</h2>

<div class="list" id="list"></div>

<div id="previewBox">
  <div style="text-align:center; background:#eee; padding:10px; position:sticky; top:0;">
    <button class="noPrint" onclick="window.print()">Print A4</button>
    <button class="noPrint" onclick="document.getElementById('previewBox').style.display='none'">Close</button>
  </div>
  <div id="printArea"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwnY99_hETH8F_nYcS1jbW_5PfuGXWHVA9ZIf-xKoJ3BjEcSZ455K38ey7wDh6qlIsSvw/exec";

/**
 * Helper to fix Image Formatting
 * Ensures Base64 has the correct header
 */
function formatImgSrc(src) {
  if (!src) return "https://via.placeholder.com/150?text=No+Image";
  if (src.startsWith("data:image")) return src;
  return "data:image/jpeg;base64," + src;
}

// LOAD DATA
async function load(){
  const listDiv = document.getElementById("list");
  const loading = document.getElementById("loadingMessage");
  
  loading.style.display = "block";
  listDiv.innerHTML = "";
  
  try {
    const res = await fetch(API, {
      method: "POST",
      body: JSON.stringify({ action: "get" })
    }).then(r => r.json());

    const searchVal = document.getElementById("searchShop").value.trim().toLowerCase();

    res.forEach(r => {
      // Search filter (columns 3, 5, 7)
      if(searchVal && !(
        String(r[3]).toLowerCase().includes(searchVal) ||
        String(r[5]).toLowerCase().includes(searchVal) ||
        String(r[7]).toLowerCase().includes(searchVal)
      )) return;

      // Handle Multiple Images Array
      let imgs = [];
      try {
        imgs = JSON.parse(r[15] || "[]");
      } catch(e) { 
        if(r[15]) imgs = [r[15]]; 
      }
      
      const mainImg = formatImgSrc(imgs[0]);

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="card-header">
          <img class="profile-thumb" src="${mainImg}" onerror="this.src='https://via.placeholder.com/150'">
          <div>
            <h3>Shop: ${r[3]}</h3>
            <span style="font-weight:bold; color:#880e4f;">${r[5]}</span>
          </div>
        </div>
        <div class="card-body">
          <p><strong>Shop Name:</strong> ${r[4]}</p>
          <p><strong>Mobile:</strong> ${r[7]}</p>
          <button class="btn-print" onclick='printView(${JSON.stringify(r)})'>View Full Profile</button>
        </div>`;
      listDiv.appendChild(card);
    });
  } catch (err) {
    console.error(err);
    alert("Error loading data. Check API connection.");
  }

  loading.style.display = "none";
}

// DATE FORMATTING
function formatDate(d){
  if(!d) return "-";
  const x = new Date(d);
  if(isNaN(x)) return d;
  const m = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return ("0"+x.getDate()).slice(-2)+"-"+m[x.getMonth()]+"-"+x.getFullYear();
}

// PRINT VIEW GENERATION
function printView(r){
  const printArea = document.getElementById("printArea");
  
  // Parse images and format each one
  let imgs = [];
  try { imgs = JSON.parse(r[15] || "[]"); } catch(e) { if(r[15]) imgs = [r[15]]; }
  
  const tenantImgsHtml = imgs.length > 0 
    ? imgs.map(i => `
        <div class="img-wrap">
          <img src="${formatImgSrc(i)}" onerror="this.src='https://via.placeholder.com/150'">
          <span>${r[5]}</span>
        </div>`).join("")
    : `<div class="img-wrap"><img src="https://via.placeholder.com/150"><span>No Image</span></div>`;

  printArea.innerHTML = `
  <div class="print-page">
    <div class="print-header">
      <img src="sa.png" onerror="this.style.display='none'">
      <div class="print-header-title">‡Æµ‡Ææ‡Æü‡Æï‡Øà‡Æ§‡Ææ‡Æ∞‡Æ∞‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç</div>
      <img src="2.jpg" onerror="this.style.display='none'">
    </div>

    <div class="print-tenants">
      ${tenantImgsHtml}
    </div>

    <table class="print-table">
      <tr><th>Complex Name</th><td>${r[1] || "-"}</td></tr>
      <tr><th>Complex No</th><td>${r[2] || "-"}</td></tr>
      <tr><th>Shop No</th><td>${r[3] || "-"}</td></tr>
      <tr><th>Shop Name</th><td>${r[4] || "-"}</td></tr>
      <tr><th>Tenant Name</th><td>${r[5] || "-"}</td></tr>
      <tr><th>F/H Name</th><td>${r[6] || "-"}</td></tr>
      <tr><th>Mobile</th><td>${r[7] || "-"}</td></tr>
      <tr><th>Alt Mobile</th><td>${r[8] || "-"}</td></tr>
      <tr><th>Address</th><td>${r[9] || "-"}</td></tr>
      <tr><th>ID Proof</th><td>${r[10] || ""} - ${r[11] || ""}</td></tr>
      <tr><th>Monthly Rent</th><td>Rs. ${r[12] || "0"}</td></tr>
      <tr><th>Advance</th><td>Rs. ${r[13] || "0"}</td></tr>
      <tr><th>Start Date</th><td>${formatDate(r[14])}</td></tr>
    </table>
    
    <div style="margin-top:30px; display:flex; justify-content:space-between; font-weight:bold;">
       <p>Tenant Signature</p>
       <p>Manager Signature</p>
    </div>
  </div>
  `;
  
  document.getElementById("previewBox").style.display = "block";
}

// INIT
load();
</script>
</body>
</html>
