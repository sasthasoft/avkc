<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shop Rent Payment System - Merged</title>
<style>
/* --- UI STYLES --- */
*{box-sizing:border-box;}
body{margin:0;font-family:Arial, sans-serif;background:#f4f6f8;}
header{background:#c2185b;color:#fff;padding:15px;text-align:center;font-size:22px;}

.container{max-width:1200px;margin:auto;padding:10px;}
.card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:15px;border-top:4px solid #c2185b;}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:10px;}
label{font-size:12px;font-weight:bold;display:block;margin-bottom:5px;}
input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;}
textarea{height:70px;resize:none;}
button{width:100%;padding:10px;border:none;border-radius:8px;background:#c2185b;color:#fff;font-weight:bold;cursor:pointer;}

/* --- SEARCH RESULT --- */
#tenantResult{margin-top:10px;background:#fce4ec;padding:15px;border-radius:8px;display:flex;flex-wrap:wrap;gap:15px;justify-content:center;}
.tenant-box{background:#fff;padding:10px;border-radius:8px;text-align:center;width:180px;border:1px solid #ddd;}
.tenant-box img{width:120px;height:140px;object-fit:cover;border-radius:5px;background:#eee;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto;}
.tenant-box span{font-size:12px;font-weight:bold;display:block;margin-bottom:5px;color:#880e4f;}

/* --- TABLE --- */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;min-width:900px;font-size:12px;margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#f06292;color:#fff;}
table img{width:50px;height:60px;object-fit:cover;border-radius:4px;}

/* --- PRINTING (HIDDEN IN UI) --- */
#bill{display:none;padding:10mm;background:#fff;color:#000;}

@media print {
  body * { visibility: hidden; }
  #bill, #bill * { visibility: visible; }
  #bill { position: absolute; left: 0; top: 0; width: 210mm; display: block; }
}
</style>
</head>
<body>

<header>Billing</header>

<div class="container">
  
  <div class="card">
    <div class="row">
      <div style="grid-column:span 2">
        <label>Search (Shop No / Name / Mobile)</label>
        <input id="searchKey" placeholder="Search Mobile or Shop No...">
      </div>
      <div style="align-self:end">
        <button onclick="searchTenant()">ЁЯФН Find Tenant</button>
      </div>
    </div>
    <div id="tenantResult"></div>
  </div>

  <div class="card">
    <h3>Payment Entry</h3>
    <div id="selectedInfo" style="text-align:center;color:green;font-weight:bold;margin-bottom:10px; font-size: 16px;"></div>
    
    <div class="row">
      <div><label>Date</label><input type="date" id="paymentDate"></div>
      <div>
        <label>Transaction ID</label>
        <select id="transactionId">
          <option value="">Select Transaction</option>
          <option>роХроЯрпИроХро│рпН ро╡ро╛роЯроХрпИ ро░роЪрпАродрпБ</option>
          <option>роЖ.ро╡рпИ. родрпБро╡роХрпНроХрокрпНрокро│рпНро│ро┐ роХроЯрпИ ро╡ро╛роЯроХрпИ ро░роЪрпАродрпБ</option>
          <option>роЕройрпНройродро╛ройроЪродрпНродро┐ро░роорпН, роорогрпНроЯрокроорпН, роХроЯрпИ ро╡ро╛роЯроХрпИ ро░роЪрпАродрпБ</option>
          <option>роЖ.ро╡рпИ. роорпЗро▓рпНроиро┐ро▓рпИрокрпНрокро│рпНро│ро┐ роХроЯрпИ ро╡ро╛роЯроХрпИ ро░роЪрпАродрпБ</option>
        </select>
      </div>
      <div>
        <label>Months (Multi Select)</label>
        <select id="months" multiple onchange="calculate()">
          <option>January</option><option>February</option><option>March</option><option>April</option>
          <option>May</option><option>June</option><option>July</option><option>August</option>
          <option>September</option><option>October</option><option>November</option><option>December</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div><label>Monthly Rental</label><input id="rental" type="number" oninput="calculate()"></div>
      <div><label>Gross Amount</label><input id="grossAmt" readonly></div>
      <div><label>Discount</label><input id="discount" type="number" value="0" oninput="calculate()"></div>
    </div>

    <div class="row">
      <div><label>Tax %</label><input id="taxPercentage" type="number" value="0" oninput="calculate()"></div>
      <div><label>Tax Amount</label><input id="taxAmt" readonly></div>
      <div><label>Net Amount</label><input id="netAmt" readonly></div>
    </div>

    <div class="row">
      <div><label>Now Paid</label><input id="nowPaid" type="number" oninput="calculate()"></div>
      <div><label>Pending</label><input id="pending" readonly style="color:red; font-weight:bold;"></div>
      <div><label>Rental Set (Optional)</label><input id="rentalSet"></div>
    </div>

    <div class="row">
      <div style="grid-column:span 2"><label>Remarks</label><textarea id="remarks"></textarea></div>
      <div><label>Upload New Image</label><input type="file" id="imgUpload" accept="image/*"></div>
    </div>
    <br>
    <button onclick="saveAndPrint()">ЁЯТ╛ Save & Print Bill</button>
  </div>

  <div class="card">
    <h3>All Payments History</h3>
    <button onclick="loadHistory()" style="width:150px; background:#444;">ЁЯФД Refresh</button>
    <div class="table-wrap">
      <table id="dataTable"><thead></thead><tbody></tbody></table>
    </div>
  </div>

</div>

<div id="bill"></div>

<script>
// --- CONFIGURATION ---
const SEARCH_URL = "https://script.google.com/macros/s/AKfycbwnY99_hETH8F_nYcS1jbW_5PfuGXWHVA9ZIf-xKoJ3BjEcSZ455K38ey7wDh6qlIsSvw/exec"; 
const PAYMENT_URL = "https://script.google.com/macros/s/AKfycbyogWMiTNNixoMp7E0NEA7-z_y0Syxxrp_NrG8hWhI7bpPRNokcNAKYo1EyZxxx6qnldA/exec";

let activeTenant = null;
let uploadedBase64 = "";

// Set default date
document.getElementById('paymentDate').valueAsDate = new Date();

/**
 * MASTER IMAGE FORMATTER
 * Handles array strings, raw base64, and empty values
 */
function formatImg(src) {
  if (!src) return "https://via.placeholder.com/120x140?text=No+Photo";
  
  // Clean JSON array if present
  if (typeof src === 'string' && src.startsWith('[')) {
    try {
      const arr = JSON.parse(src);
      src = arr[0];
    } catch(e) {}
  }
  
  if (src.startsWith("data:image")) return src;
  if (src.length > 100) return "data:image/jpeg;base64," + src;
  return src;
}

// Convert uploaded file to Base64
document.getElementById("imgUpload").addEventListener("change", e => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = () => uploadedBase64 = reader.result;
    reader.readAsDataURL(file);
  }
});

/**
 * SEARCH TENANT
 * Uses SEARCH_URL to get master tenant details
 */
async function searchTenant() {
  const key = document.getElementById("searchKey").value;
  const resDiv = document.getElementById("tenantResult");
  if(!key) return alert("Please enter Shop No, Name or Mobile");

  resDiv.innerHTML = "Searching Database...";
  
  try {
    const res = await fetch(SEARCH_URL, { method: "POST", body: JSON.stringify({ action: "get" }) });
    const data = await res.json();
    
    resDiv.innerHTML = "";
    // Filter columns: 3 (Shop), 5 (Name), 7 (Mobile)
    const filtered = data.filter(r => 
      String(r[3]).toLowerCase().includes(key.toLowerCase()) || 
      String(r[5]).toLowerCase().includes(key.toLowerCase()) ||
      String(r[7]).includes(key)
    );

    if(filtered.length === 0) {
      resDiv.innerHTML = "тЭМ No tenant found.";
      return;
    }

    filtered.forEach(r => {
      const imgUrl = formatImg(r[15]); // Column 15 is Image
      const box = document.createElement("div");
      box.className = "tenant-box";
      box.innerHTML = `
        <img src="${imgUrl}">
        <span>${r[5]} (Shop ${r[3]})</span>
        <button style="padding:5px;font-size:11px;background:#2e7d32;" onclick='selectTenant(${JSON.stringify(r)})'>Select</button>
      `;
      resDiv.appendChild(box);
    });
  } catch(e) { 
    resDiv.innerHTML = "Error connecting to server."; 
  }
}

function selectTenant(r) {
  activeTenant = r;
  document.getElementById("rental").value = r[12]; // Column 12 is Rent
  document.getElementById("selectedInfo").innerText = `SELECTED: ${r[5]} | Shop: ${r[3]}`;
  document.getElementById("tenantResult").innerHTML = "";
  calculate();
}

function calculate() {
  const count = [...document.getElementById("months").selectedOptions].length;
  const rent = +document.getElementById("rental").value || 0;
  const gross = count * rent;
  document.getElementById("grossAmt").value = gross;

  const disc = +document.getElementById("discount").value || 0;
  const tax = ((gross - disc) * (+document.getElementById("taxPercentage").value || 0)) / 100;
  document.getElementById("taxAmt").value = tax.toFixed(2);

  const net = gross - disc + tax;
  document.getElementById("netAmt").value = net.toFixed(2);
  const paid = +document.getElementById("nowPaid").value || 0;
  document.getElementById("pending").value = (net - paid).toFixed(2);
}

/**
 * SAVE AND PRINT
 * Uses PAYMENT_URL to record transaction
 */
async function saveAndPrint() {
  if(!activeTenant) return alert("Please select a tenant first!");

  const data = {
    action: "savePayment",
    tenantName: activeTenant[5],
    shopNo: activeTenant[3],
    mobile: activeTenant[7],
    paymentDate: document.getElementById("paymentDate").value,
    transactionId: document.getElementById("transactionId").value,
    months: [...document.getElementById("months").selectedOptions].map(o=>o.value).join(", "),
    monthsCount: [...document.getElementById("months").selectedOptions].length,
    rental: document.getElementById("rental").value,
    grossAmt: document.getElementById("grossAmt").value,
    discount: document.getElementById("discount").value,
    taxPercentage: document.getElementById("taxPercentage").value,
    taxAmt: document.getElementById("taxAmt").value,
    netAmt: document.getElementById("netAmt").value,
    nowPaid: document.getElementById("nowPaid").value,
    pending: document.getElementById("pending").value,
    rentalSet: document.getElementById("rentalSet").value,
    remarks: document.getElementById("remarks").value,
    imageBase64: uploadedBase64 || formatImg(activeTenant[15])
  };

  try {
    const res = await fetch(PAYMENT_URL, { method: "POST", body: JSON.stringify(data) });
    const result = await res.json();
    
    alert("Saved Successfully! Bill No: " + result.billNo);
    generateBillPrint(data, result.billNo);
    
    // Trigger Print
    printBill();
    loadHistory();
  } catch(e) {
    alert("Error saving payment.");
  }
}

function generateBillPrint(d, billNo) {
  const billDiv = document.getElementById("bill");
  billDiv.innerHTML = `
    <div class="print-header">
      <img src="sa.png" class="logo">
      <div class="print-title">
        <div>роЙ</div>
        <div><h5 style="margin:0;">тАО тАОро╕рпНро░рпА ро░ро╛роЬро░ро╛роЬрпЗро╕рпНро╡ро░ро┐ роЕроорпНрокро╛ро│рпН родрпБрогрпИ</h5></div>
        <div class="line1" style="margin-top:5px; font-size:14px; font-weight:bold;color:green;">роХрпЛро╡ро┐ро▓рпНрокроЯрпНроЯро┐ роЖропро┐ро░ ро╡рпИроЪро┐роп роХро╛роЪрпБроХрпНроХро╛ро░роЪрпН роЪрпЖроЯрпНроЯро┐рокрпНрокро┐ро│рпНро│рпИроХро│рпН роЪроЩрпНроХроорпН</div>
        <div class="line2" style="font-size:11px;">23, ро╡роЯроХрпНроХрпБ ро░род ро╡рпАродро┐ роЪро┐ро╡ройрпН роХрпЛропро┐ро▓рпН родрпЖро░рпБ, роХрпЛро╡ро┐ро▓рпНрокроЯрпНроЯро┐ - 628 501</div>
        <div class="line4" style="margin-top:5px; font-size:14px; font-weight:bold;color:blue;">${d.transactionId || "-"}</div>
      </div>
      <img src="2.jpg" class="logo">
    </div>

    <table width="100%" style="margin-top:15px; border-collapse:collapse;">
      <tr>
        <td width="30%" rowspan="2" align="center">
          <img src="${d.imageBase64}" class="customer-img">
        </td>
        <td width="70%" style="text-align:left; padding-left:15px;">
          <h3 style="margin:5px 0;"><b>ро╡ро╛роЯроХрпИродро╛ро░ро░рпН :</b> ${d.tenantName}</h3>
          <p style="margin:5px 0;"><b>роорпКрокрпИро▓рпН :</b> ${d.mobile}</p>
        </td>
      </tr>
      <tr>
        <td style="text-align:left; padding-left:15px;">
          <h3 style="margin:5px 0;"><b>роХроЯрпИ роОрогрпН :</b> ${d.shopNo} &nbsp;&nbsp; <b>рооро╛род ро╡ро╛роЯроХрпИ :</b> тВ╣${d.rental}</h3>
        </td>
      </tr>
    </table>

    <h3 style="margin-top:20px; text-align:center;">роХроЯрпНроЯрог ро╡ро┐ро╡ро░роЩрпНроХро│рпН</h3>
    <table width="100%" border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse; text-align:center;">
      <tr style="background:#f3f3f3;">
        <th>Bill No</th><th>Date</th><th>Month of Pay</th><th>Rental</th><th>Tax</th><th>Now Paying</th><th>Pending</th>
      </tr>
      <tr>
        <td>${billNo}</td>
        <td>${d.paymentDate}</td>
        <td style="font-size:10px;">${d.months}</td>
        <td>тВ╣${d.rental}</td>
        <td>${d.taxPercentage}%</td>
        <td>тВ╣${d.nowPaid}</td>
        <td style="color:red;">тВ╣${d.pending}</td>
      </tr>
    </table>

    <p style="margin-top:10px;"><b>роХрпВроЯрпБродро▓рпН ро╡ро┐ро╡ро░роЩрпНроХро│рпН :</b> ${d.remarks || "-"}</p>

    <div style="font-size:10px; margin-top:15px; border-top:1px solid #000; padding-top:10px;">
      <h4 style="margin:0 0 5px 0;">ро╡ро╛роЯроХрпИ роиро┐рокроирпНродройрпИроХро│рпН</h4>
 1.рооро╛род ро╡ро╛роЯроХрпИ рокрпЗроЪро┐ роТрокрпНрокрпБроХрпНроХрпКрогрпНроЯрпБ роорпВройрпНро▒рпБ рооро╛род ро╡ро╛роЯроХрпИ роЕроЯрпНро╡ро╛ройрпНро╕ро╛роХ роЪрпЖро▓рпБродрпНрод ро╡рпЗрогрпНроЯрпБроорпН. рооро╛род ро╡ро╛роЯроХрпИропрпИ рооро▒рпБрооро╛родроорпН 5роорпН родрпЗродро┐роХрпНроХрпБро│рпН роЪрпЖро▓рпБродрпНрод ро╡рпЗрогрпНроЯрпБроорпН. родро╡ро▒ро┐ройро╛ро▓рпН ро╡роЯрпНроЯро┐ропрпБроЯройрпН роЪрпЗро░рпНродрпНродрпБ ро╡роЪрпВро▓ро┐роХрпНроХрокрпНрокроЯрпБроорпН.<br>
2. роОроХрпНроХро╛ро░рогродрпНродрпИ роорпБройрпНройро┐роЯрпНроЯрпБроорпН роЙро│рпНро╡ро╛роЯроХрпИроХрпНроХрпЛ ро╡рпЗро▒рпБ роирокро░рпБроХрпНроХрпЛ рооро╛ро▒рпНро▒ро┐роХрпН роХрпКро│рпНро│ро╡рпЛ ро╡ро╛роЯроХрпИродро╛ро░ро░рпБроХрпНроХрпБ роЙро░ро┐роорпИ роХро┐роЯрпИропро╛родрпБ. роХроЯрпНроЯро┐роЯроорпН
родрпЗро╡рпИропро┐ро▓рпНро▓рпИропрпЖройрпНро▒ро╛ро▓рпН ро╡ро╛роЯроХрпИ рокро╛роХрпНроХро┐роХро│рпН роЪроХро┐родроорпН роОроЩрпНроХро│рпН ро╡роЪроорпН роТрокрпНрокрпБро╡ро┐роХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН. ро╡ро╛роЯроХрпИродро╛ро░ро░рпНроХро│рпН ро░ро┐рокрпНрокрпЗро░рпН роЪрпЖропрпНродрпБроХрпКро│рпНро│ роЙро░ро┐роорпИ роХро┐роЯрпИропро╛родрпБ.<br>
3. роОро▓роХрпНроЯрпНро░ро┐роХрпН роЪро╛ро░рпНроЬрпНроХро│рпИ рооро╛род-рооро╛родроорпН ро╡ро╛роЯроХрпИродро╛ро░ро░рпНроХро│рпН роЪрпЖро▓рпБродрпНродро┐роХрпН роХрпКро│рпНро│ро╡рпЗрогрпНроЯрпБроорпН.<br>
4. роХроЯрпНроЯро┐роЯроорпН роХро╛ро▓ро┐роЪрпЖропрпНропрпБроорпН рокрпЛродрпБ ро╡ро╛роЯроХрпИрокрпН рокро╛роХрпНроХро┐роХро│рпН рокрпВро░ро╛ро╡рпБроорпН роЪрпЖро▓рпБродрпНродро┐ро╡ро┐роЯрпНроЯрпБ роЕроЯрпНро╡ро╛ройрпНро╕рпН родрпКроХрпИропрпИ ро╡ро╛рокро╕рпН рокрпЖро▒рпНро▒рпБроХрпНроХрпКро│рпНро│ ро╡рпЗрогрпНроЯрпБроорпН. роЖроХрпНроХро┐ро░рооро┐рокрпНрокрпБроХрпНроХрпБ роЗроЯроорпН роХрпКроЯрпБроХрпНроХроХрпН роХрпВроЯро╛родрпБ роЖроХрпНроХро┐ро░рооро┐рокрпНрокрпБ роЪрпЖропрпНропро╡рпБроорпН роХрпВроЯро╛родрпБ.<br>
5. роЗродройрпНрокроЯро┐ роироЯроирпНродрпБ ро╡ро░рпБро╡рпЗройро╛роХро╡рпБроорпН.<br>
6. роЕро░роЪро╛ро▓рпН ро╡ро┐родро┐роХрпНроХрокрпНрокроЯрпБроорпН (GST) ро╡ро░ро┐ роироЯрпИроорпБро▒рпИропро┐ро▓рпН роЗро░рпБроирпНродро╛ро▓рпН,
роЕродро▒рпНроХро╛рой родрпКроХрпИропрпИ ро╡ро╛роЯроХрпИродро╛ро░ро░рпЗ роЪрпЖро▓рпБродрпНрод ро╡рпЗрогрпНроЯрпБроорпН.<br>

7. ро╡ро░ро┐ роЪрпЖро▓рпБродрпНродродрпН родро╡ро▒ро┐ройро╛ро▓рпН роЕро▓рпНро▓родрпБ родро╛роородрооро╛ройро╛ро▓рпН,
роЕродройро╛ро▓рпН роПро▒рпНрокроЯрпБроорпН роЕрокро░ро╛родроорпН, ро╡роЯрпНроЯро┐ роЕро▓рпНро▓родрпБ роЪроЯрпНроЯ роироЯро╡роЯро┐роХрпНроХрпИроХро│рпБроХрпНроХро╛рой
роорпБро┤рпБрокрпН рокрпКро▒рпБрокрпНрокрпБроорпН ро╡ро╛роЯроХрпИродро╛ро░ро░рпИропрпЗ роЪро╛ро░рпБроорпН.<br>
    </div>

    <div style="margin-top:40px; display:flex; justify-content:space-between; font-weight:bold;">
      <div>ро╡ро╛роЯроХрпИродро╛ро░ро░рпН роХрпИропрпКрокрпНрокроорпН ____________</div>
      <div>роиро┐ро░рпНро╡ро╛роХро┐ роХрпИропрпКрокрпНрокроорпН ____________</div>
    </div>
  `;
}

function printBill() {
  const content = document.getElementById("bill").innerHTML;
  const iframe = document.createElement('iframe');
  iframe.style.position = 'fixed';
  iframe.style.right = '0';
  iframe.style.bottom = '0';
  iframe.style.width = '0';
  iframe.style.height = '0';
  iframe.style.border = '0';
  document.body.appendChild(iframe);
  
  const doc = iframe.contentWindow.document;
  doc.open();
  doc.write(`
    <html>
      <head>
        <title>Print Receipt</title>
        <style>
          @page { size: A4; margin: 10mm; }
          body { font-family: Arial, sans-serif; color: #000; }
          .print-header { display:flex; align-items:center; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:10px; }
          .logo { width:70px; }
          .print-title { flex:1; text-align:center; }
          .customer-img { width:120px; height:140px; border:1px solid #000; object-fit:cover; margin-top:10px; }
          table { width:100%; border-collapse:collapse; margin-top:10px; }
          th, td { border:1px solid #000; padding:6px; text-align:center; }
          th { background: #f3f3f3; font-weight:bold; }
        </style>
      </head>
      <body>${content}</body>
    </html>
  `);
  doc.close();
  
  iframe.contentWindow.focus();
  iframe.contentWindow.print();
  setTimeout(() => document.body.removeChild(iframe), 1000);
}

async function loadHistory() {
  try {
    const res = await fetch(PAYMENT_URL, { method: "POST", body: JSON.stringify({ action: "getPayments" }) });
    const result = await res.json();
    const b = document.querySelector("#dataTable tbody");
    const h = document.querySelector("#dataTable thead");
    
    h.innerHTML = b.innerHTML = "";
    if(!result.data || result.data.length === 0) return;

    const keys = Object.keys(result.data[0]).filter(k => k !== "row");
    h.innerHTML = "<tr>" + keys.map(k => `<th>${k}</th>`).join("") + "</tr>";
    
    result.data.forEach(row => {
      let tr = "<tr>";
      keys.forEach(k => {
        if(k.toLowerCase().includes("image") && row[k]) {
          tr += `<td><img src="${formatImg(row[k])}"></td>`;
        } else {
          tr += `<td>${row[k] || ""}</td>`;
        }
      });
      b.innerHTML += tr + "</tr>";
    });
  } catch(e) { console.log("History failed to load"); }
}

// Initialize history on load
loadHistory();

</script>
</body>
</html>
